---
title: 微前端解决方案2 - 模块化加载器 
categories: 项目方案
date: 2020-04-06 13:10:51
tags:
  - 项目方案
  - 微前端
  - 实践
---
> 模块加载器，即自动发现所有模块中的配置文件（manifest），读取配置生成代理，循环注册等等，组成模块加载器。

ps：实践代码采用github外链形式在文章底部，文章中仅提供关键思路以及代码，如有需要自行下载。

## 
既然是选型做微前端，当然选型 single-spa 做微前端的基石。当然，为了实现轻松容易，需有良好的设计，才能事半功倍。

以下是设计部分：

### 模块化加载器
1. 自动发现所有模块中的配置文件（manifest），合并生成一个manifests放在base项目根目录下，这样就可以通过请求来读取对应配置， 同时base根目录有配置文件的时候，需要优先使用配置文件（后端可以读写文件做插件化）。

2. 读取配置文件后，如果是开发环境则需要先在项目启动的时候，对子模块生成端口代理（proxy解决跨域问题），生产环境则跳过。base项目读取到manifest后，循环队列，请求到对应使用singlespa注册方法进行循环注册。

3. 注册会请求对应端口或路径下的stats.json统计文件，请求，并加载在dom上，js运行，对应的singlespa子模块实例就会被挂载在window对象上。

4. singlespa注册会去拿manifest的信息和window上的实例一起进行注册。

### 消息总线
1. 先将store改写，去掉vuex实例化，只导出配置，在webpack配置中将store的路径添加到entry入口。

2. 在模块加载器步骤3 后，会去拿window上对应命名空间下的store，在注册时使用customprops自动派发到所有子模块。

3. 子模块接受到再注入到自己的this.$store。

### 路由分发（动态路由）
动态路由是为了左侧菜单动态展示，和菜单权限配置。
1. router部分保持之前的，在router.js内进行实例化，在main.js引入，需要增加的是导出routes配置。

2. routes配置在本模块的store引入，这样，base模块消息总线贯通后就可以直接获取对应命名空间下的router，进而拼出一个完整版本的路由。


### 构建部署
构建和部署，就是需要看产品需要了，
1. 方案1，跟开发一样，多个端口部署多个模块，利用nginx，进行代理配合。
2. 方案2，都部署在一个文件夹内，根据路径来区分不同模块。可以节约端口，但是失去了独立部署的优势。


至此，微前端方案的模块加载器部分，就实践完毕了。

但是目前项目只支持模块内的消息通信，总体的通信怎么实现呢？

> 未完，待续 ...

项目链接：https://github.com/shifeng1993/single-spa-demo

